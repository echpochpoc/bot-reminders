import re
import datetime
from dateutil.relativedelta import relativedelta

from aiogram import types, Dispatcher
from aiogram.dispatcher.filters import Text
from aiogram.dispatcher.filters.state import State, StatesGroup
from aiogram.dispatcher import FSMContext

from core.create_connect import bot
from core.filters.filters import StateClassFilter, UserIsRegistered
from core.keyboards import keyboards
from db.queries import queries
from db.models import Reminder


class ReminderState(StatesGroup):
    text = State()
    times = State()
    dates_send = State()
    days_week = State()
    date_delete = State()
    users = State()
    groups = State()


async def reminder_start(message: types.Message):
    await message.answer('–†–µ–∂–∏–º —Å–æ–∑–¥–∞–Ω–∏—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è, –¥–ª—è –æ—Ç–º–µ–Ω—ã –≤–≤–µ–¥–∏—Ç–µ /cancel')
    await msg_get_text(message)


async def msg_get_text(message: types.Message):
    kb = keyboards.get_kb_back()
    await message.answer('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è',
                         reply_markup=kb)
    await ReminderState.text.set()


async def get_text(message: types.Message, state: FSMContext):
    await state.update_data(text=message.text.strip())
    await msg_get_times(message)


async def msg_get_times(message: types.Message):
    await message.answer('–í–≤–µ–¥–∏—Ç–µ –≤—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–µ \n'
                         '–ù–∞–ø—Ä–∏–º–µ—Ä: 1000, 1230 –∏–ª–∏ 2135, –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–Ω–∞—á–µ–Ω–∏–π –≤–≤–µ–¥–∏—Ç–µ —á–µ—Ä–µ–∑ –ø—Ä–æ–±–µ–ª '
                         '–∏–ª–∏ –≤–æ—Å–ø–æ–ª—å–∑—É–π—Ç–µ—Å—å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π',
                         reply_markup=keyboards.get_clock(hour=9, minute=0))
    await ReminderState.times.set()


async def get_times_call(call: types.CallbackQuery, state: FSMContext):
    hour, minute = map(int, re.findall(r'\d+', call.data))
    times = datetime.time(hour, minute)
    await state.update_data(times=[times])
    await call.answer()
    await msg_get_dates_send(call.message)


async def get_times_str(message: types.Message, state: FSMContext):
    times = check_time(message.text)
    if not times:
        await message.answer('–í—Ä–µ–º—è –≤–≤–µ–¥–µ–Ω–æ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ')
    else:
        await state.update_data(times=times)
        await msg_get_dates_send(message)


async def msg_get_dates_send(message: types.Message):
    inline_kb = keyboards.get_kb_calendar()
    await message.answer('–î–∞—Ç—ã –≤—ã–±—Ä–∞–Ω—ã: ', reply_markup=inline_kb)
    await ReminderState.dates_send.set()


async def get_dates_send(call: types.CallbackQuery, state: FSMContext):
    if 'cal_day' in call.data:
        text = edit_text_msg_dates_send(text=call.message.text,
                                        call=call.data)
        try:
            await call.message.edit_text(text, reply_markup=call.message.reply_markup)
        except:
            pass
    elif call.data == 'cal_done':
        dates = []
        dates_str = call.message.text.replace('–î–∞—Ç—ã –≤—ã–±—Ä–∞–Ω—ã: ', '').split(' ')
        if not (dates_str[0] == '–î–∞—Ç—ã'):
            for date_str in dates_str:
                dates.append(datetime.datetime.strptime(date_str, '%d.%m.%Y'))
        await state.update_data(dates_send=dates)
        await msg_get_days_week(call.message)
    await call.answer()


async def msg_get_days_week(message: types.Message):
    kb = keyboards.get_inline_kb_days_week()
    await message.answer('–í—ã–±–µ—Ä–∏—Ç–µ –¥–Ω–∏ –Ω–µ–¥–µ–ª–∏: ', reply_markup=kb)
    await ReminderState.days_week.set()


async def get_days_week(call: types.CallbackQuery, state: FSMContext):
    if call.data == 'days_week_done':
        kb = call.message.reply_markup['inline_keyboard']
        days = keyboards.get_data_on_keyboards(kb)
        await state.update_data(days_week=days)
        async with state.proxy() as data:
            if not data['dates_send'] and not data['days_week']:
                await call.answer('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –¥–µ–Ω—å –æ—Ç–ø—Ä–∞–≤–∫–∏')
                return
        await msg_get_date_delete(call.message)
    elif 'days_week' in call.data:
        kb = call.message.reply_markup['inline_keyboard']
        new_kb = keyboards.edit_inline_kb(kb, call.data)
        try:
            await call.message.edit_text(call.message.text, reply_markup=new_kb)
        except:
            pass
    await call.answer()


async def msg_get_date_delete(message: types.Message):
    kb = keyboards.get_kb_calendar()
    await message.answer('–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É —É–¥–∞–ª–µ–Ω–∏—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è: ',
                         reply_markup=kb)
    await ReminderState.date_delete.set()


async def get_date_delete(call: types.CallbackQuery, state: FSMContext):
    if 'cal_day' in call.data:
        date_str = '.'.join(re.findall(r'\d+', call.data))
        date = datetime.datetime.strptime(date_str, '%d.%m.%Y')
        if datetime.datetime.now() > date:
            await call.answer('–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –ø–æ–∑–∂–µ —á–µ–º —Å–µ–≥–æ–¥–Ω—è')
            return
        await state.update_data(date_delete=date)
    else:
        await state.update_data(date_delete=None)
    await msg_get_users(call.message)
    await call.answer()


async def msg_get_users(message: types.Message):
    kb = keyboards.get_inline_kb_users(await queries.select_users_all())
    await message.answer(f'–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ', reply_markup=kb)
    await ReminderState.users.set()


async def get_users(call: types.CallbackQuery, state: FSMContext):
    if call.data == 'user_done':
        users = keyboards.get_data_on_keyboards(
            inline_kb=call.message.reply_markup['inline_keyboard'])
        await state.update_data(users=users)
        await msg_get_groups(call.message)
    else:
        kb = keyboards.edit_inline_kb(inline_kb=call.message.reply_markup['inline_keyboard'],
                                      call=call.data)
        try:
            await call.message.edit_text(text=call.message.text, reply_markup=kb)
        except:
            pass
    await call.answer()


async def msg_get_groups(message: types.Message):
    kb = keyboards.get_inline_kb_groups(await queries.select_groups_all())
    await message.answer(text='–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—ã: ', reply_markup=kb)
    await ReminderState.groups.set()


async def get_groups(call: types.CallbackQuery, state: FSMContext):
    if call.data == 'group_done':
        groups = keyboards.get_data_on_keyboards(
            inline_kb=call.message.reply_markup['inline_keyboard'])
        await state.update_data(groups=groups)
        async with state.proxy() as data:
            if not data['users'] and not data['groups']:
                await call.answer('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –≥—Ä—É–ø–ø—É')
                return
        await end_rem(call.message, state)
        await call.answer()
    elif 'group' in call.data:
        kb = keyboards.edit_inline_kb(inline_kb=call.message.reply_markup['inline_keyboard'],
                                      call=call.data)
        await call.message.edit_text(text=call.message.text, reply_markup=kb)


async def end_rem(message: types.Message, state: FSMContext):
    """
    –î–æ–±–∞–≤–ª—è–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –∏ –≤—ã–∑—ã–≤–∞–µ—Ç –º–µ—Ç–æ–¥ —Ä–∞—Å—Å—ã–ª–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –æ –Ω–æ–≤–æ–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–∏
    """
    async with state.proxy() as data:
        creator = await queries.select_user(telegram_id=message.chat.id)
        reminder = Reminder(
            creator_id=creator.id, text=data['text'],
            date_delete=data['date_delete'], times=data['times'],
            days_week=data['days_week'], dates=data['dates_send'],
        )
        users = await get_set_users(data['users'], data['groups'])
    await message.answer('–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ',
                         reply_markup=keyboards.get_kb_main_menu())
    reminder = await queries.insert_reminder(reminder, users)
    await message_users(reminder=reminder)
    await state.finish()


async def message_users(reminder: Reminder):
    users = await queries.select_users_on_reminder(reminder_id=reminder.id)
    creator = await queries.select_creator(reminder_id=reminder.id)
    for user in users:
        kb = keyboards.get_inline_kb_reminder_details(reminder_id=reminder.id)
        await bot.send_message(chat_id=user.telegram_id,
                               text=f'{creator.shortname} —Å–æ–∑–¥–∞–ª –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –¥–ª—è –≤–∞—Å:\n{reminder.text}',
                               reply_markup=kb)


async def go_back(message: types.message, state: FSMContext):
    function_dict = {
        "ReminderState:text": msg_get_text,
        "ReminderState:times": msg_get_text,
        "ReminderState:dates_send": msg_get_times,
        "ReminderState:days_week": msg_get_dates_send,
        "ReminderState:date_delete": msg_get_days_week,
        "ReminderState:users": msg_get_date_delete,
        "ReminderState:groups": msg_get_users,

    }
    now_state = await state.get_state()
    if now_state in function_dict:
        await function_dict[now_state](message)


def register_handler(dp: Dispatcher):
    dp.register_message_handler(reminder_start, UserIsRegistered(), commands=['reminder'])
    dp.register_message_handler(reminder_start, UserIsRegistered(), Text(equals='üñä–°–æ–∑–¥–∞—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ'))
    dp.register_callback_query_handler(clock_edit, Text(startswith='clock'), state=ReminderState.times)
    dp.register_callback_query_handler(cal_edit, Text(startswith='cal_month'), state='*')
    dp.register_message_handler(go_back, StateClassFilter(state_class='ReminderState'),
                                Text(equals='‚¨ÖÔ∏è–ù–∞–∑–∞–¥'), state='*')

    dp.register_message_handler(get_text, state=ReminderState.text)
    dp.register_message_handler(get_times_str, state=ReminderState.times)
    dp.register_callback_query_handler(get_times_call, Text(startswith='time_done'), state=ReminderState.times)
    dp.register_callback_query_handler(get_dates_send, Text(startswith='cal'), state=ReminderState.dates_send)
    dp.register_callback_query_handler(get_days_week, Text(startswith='days_week'), state=ReminderState.days_week)
    dp.register_callback_query_handler(get_date_delete, Text(startswith='cal'), state=ReminderState.date_delete)
    dp.register_callback_query_handler(get_users, Text(startswith='user'), state=ReminderState.users)
    dp.register_callback_query_handler(get_groups, Text(startswith='group'), state=ReminderState.groups)


def check_time(text: str) -> list[datetime.time]:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤—Ä–µ–º—è, –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –≤–≤–æ–¥–∞. –ü—Ä–∏–Ω–∏–º–∞–µ—Ç —Ç–µ—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è, –∏ —Ä–∞–∑–±–∏–≤–∞–µ—Ç –µ–≥–æ –ø–æ –ø—Ä–æ–±–µ–ª–∞–º
    –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–∞–∂–¥—ã–π —ç–ª–µ–º–µ–Ω—Ç —Å–ø–∏—Å–∫–∞:
    1230 - –¥–æ–±–∞–≤–∏—Ç –≤ —Ä–µ–∑—É–ª—å—Ç–∏—Ä—É—é—â–∏–π —Å–ø–∏—Å–æ–∫
    1278 - –æ—à–∏–±–∫–∞ => –≤–µ—Ä–Ω–µ—Ç –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫
    :param text: –¢–µ—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –≤—Ä–µ–º—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ (%H%M),
    –Ω–µ—Å–∫–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –ø—Ä–æ–±–µ–ª, –ø—Ä–∏–º–µ—Ä: '1010 1630'
    :return: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –æ–±—ä–µ–∫—Ç–æ–≤ datetime.time
    """
    result = []
    list_str = text.split()
    for temp in list_str:
        try:
            time = datetime.datetime.strptime(f'{temp}', '%H%M').time()
            result.append(time)
        except ValueError:
            return []
    return result


async def clock_edit(call: types.CallbackQuery):
    """
    –ú–µ–Ω—è–µ—Ç –≤—Ä–µ–º—è –Ω–∞ —á–∞—Å–∞—Ö
    """
    hour, minute = map(int, re.findall(r'\d+', call.data))
    time = datetime.time(hour, minute)
    delta = get_timedelta(callback=call.data)
    time = (datetime.datetime.combine(datetime.date.today(), time) + delta).time()
    kb = keyboards.get_clock(hour=time.hour, minute=time.minute)
    try:
        await call.message.edit_text(call.message.text, reply_markup=kb)
    except:
        pass


def get_timedelta(callback) -> datetime.timedelta:
    if 'clock_H' in callback:
        if "clock_H_*+" in callback:
            hour = 4
        elif "clock_H_+" in callback:
            hour = 1
        elif "clock_H_*-" in callback:
            hour = -4
        else:
            hour = -1
        delta = datetime.timedelta(hours=hour)
    else:
        if "clock_M_*+" in callback:
            minute = 15
        elif "clock_M_+" in callback:
            minute = 1
        elif "clock_M_*-" in callback:
            minute = -15
        else:
            minute = -1
        delta = datetime.timedelta(minutes=minute)
    return delta


async def cal_edit(call: types.CallbackQuery) -> None:
    """
    –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –≤—ã–±–æ—Ä–æ–º –¥–∞—Ç—ã, –º–µ–Ω—è–µ—Ç –º–µ—Å—è—Ü—ã.
    :param call: –°–æ–¥–µ—Ä–∂–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–µ—Å—è—Ü–µ –∏ –≥–æ–¥–µ –≤ –≤–∏–¥–µ 'cal_month_next_{month}_{year}'
    :return:
    """
    date = [int(num) for num in re.findall(r'\d+', call.data)]
    date = datetime.date(year=date[1], month=date[0], day=1)
    if 'cal_month_next' in call.data:
        date = date + relativedelta(months=1)
    else:
        date = date - relativedelta(month=-1)
    inline_kb = keyboards.get_kb_calendar(year=date.year, month=date.month)
    await call.message.edit_text(call.message.text, reply_markup=inline_kb)


def edit_text_msg_dates_send(text: str, call: str) -> str:
    """
    –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç —Ç–µ—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è, –¥–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—É—é –¥–∞—Ç—É –∏–ª–∏ —É–¥–∞–ª—è–µ—Ç —É–∂–µ –∏–º–µ—é—â–µ—é—Å—è
    """
    date = ".".join(re.findall(r'\d+', call))
    if date in text:
        text = text.replace(f'{date}', '')
    else:
        text = f'{text} {date}'
    return text


async def get_set_users(users_id: list[int], groups_id: list[int]) -> set:
    users_list = set()
    users_groups = (await queries.select_users_on_groups(groups_id=groups_id))
    for user in users_groups:
        users_list.add(user.id)
    for user in users_id:
        users_list.add(user)
    return users_list
